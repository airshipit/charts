# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- hosts: primary
  vars_files:
  - vars.yaml
  vars:
    work_dir: "{{ zuul.project.src_dir }}"
  roles:
  - role: setup-helm
  - role: ensure-chart-testing
  - name: chart-testing
    chart_testing_options: "--chart-dirs=. --validate-maintainers=false"
    zuul_work_dir: "{{ work_dir }}/charts"
  - role: build-helm-packages
  tasks:
  - name: Check for trailing whitespaces
    command: git grep -E -l -I " +$"
    register: result
    failed_when: result.stdout != ""
    args:
      chdir: "{{ zuul.project.src_dir }}"
  - name: Check for Windows line endings
    command: grep --files-with-match --recursive -I --binary --exclude-dir=.git --perl-regexp '\r$' .
    register: line_endings_result
    failed_when: line_endings_result.rc == 0
    args:
      chdir: "{{ zuul.project.src_dir }}"
